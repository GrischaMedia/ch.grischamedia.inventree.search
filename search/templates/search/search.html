<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{{ header_title }}</title>
  <style>
body {
  margin: 0;
  padding: 0;
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
  background-color: #f5f5f5;
  color: #212529;
}

.page {
  display: flex;
  flex-direction: column;
}

.topbar {
  background-color: #2c3e50;
  color: white;
  padding: 1rem 2rem;
  font-weight: 600;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  display: flex;
  align-items: center;
  gap: 0.75rem;
}

.version-badge {
  display: inline-block;
  background-color: rgba(255, 255, 255, 0.2);
  color: white;
  padding: 0.25rem 0.5rem;
  border-radius: 0.25rem;
  font-size: 0.75rem;
  font-weight: 500;
  border: 1px solid rgba(255, 255, 255, 0.3);
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.container {
  max-width: 1200px;
  margin: 2rem auto;
  padding: 0 1rem;
  width: 100%;
}

.card {
  background: white;
  border-radius: 0.5rem;
  box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
  margin-bottom: 2rem;
}

.card-header {
  padding: 1.5rem;
  border-bottom: 1px solid #dee2e6;
  background-color: #f8f9fa;
  border-radius: 0.5rem 0.5rem 0 0;
}

.card-title {
  margin: 0;
  font-size: 1.5rem;
  font-weight: 600;
  color: #212529;
}

.card-body {
  padding: 1.5rem;
  overflow: visible;
}

.search-input-wrapper {
  position: relative;
  margin-bottom: 1.5rem;
}

.search-input {
  width: calc(100% - 2rem);
  padding: 0.75rem 1rem;
  font-size: 1rem;
  border: 2px solid #ced4da;
  border-radius: 0.5rem;
  transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
  box-sizing: border-box;
}

.search-input:focus {
  outline: 0;
  border-color: #212529;
  box-shadow: 0 0 0 0.25rem rgba(33, 37, 41, 0.25);
}

.search-icon {
  position: absolute;
  right: 1rem;
  top: 50%;
  transform: translateY(-50%);
  color: #6c757d;
}

.results-container {
  margin-top: 2rem;
}

.result-item {
  padding: 1rem;
  border: 1px solid #dee2e6;
  border-radius: 0.25rem;
  margin-bottom: 0.75rem;
  background-color: #fff;
  transition: box-shadow 0.15s ease-in-out;
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  gap: 1rem;
}

.result-item-content {
  flex: 1;
}

.result-item-sidebar {
  text-align: right;
  min-width: 200px;
  color: #6c757d;
  font-size: 0.875rem;
}

.result-item:hover {
  box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.1);
}

.result-item h4 {
  margin: 0 0 0.5rem 0;
  font-size: 1.1rem;
  font-weight: 600;
}

.result-item h4 a {
  color: #212529;
  text-decoration: none;
}

.result-item h4 a:hover {
  text-decoration: underline;
  color: #000000;
}

.result-meta {
  color: #6c757d;
  font-size: 0.875rem;
  margin-bottom: 0.5rem;
}

.result-description {
  color: #212529;
  font-size: 0.9rem;
  margin-top: 0.5rem;
}

.no-results {
  text-align: center;
  padding: 2rem;
  color: #6c757d;
}

.alert {
  position: relative;
  padding: 0.75rem 1.25rem;
  margin-bottom: 1rem;
  border: 1px solid transparent;
  border-radius: 0.25rem;
}

.alert-info {
  color: #055160;
  background-color: #cff4fc;
  border-color: #b6effb;
}

.d-none {
  display: none !important;
}

.text-muted {
  color: #6c757d;
}

.badge {
  display: inline-block;
  padding: 0.25em 0.6em;
  font-size: 0.75em;
  font-weight: 700;
  line-height: 1;
  color: #fff;
  text-align: center;
  white-space: nowrap;
  vertical-align: baseline;
  border-radius: 0.25rem;
  background-color: #6c757d;
}

.badge-primary {
  background-color: #212529;
}

.alert-danger {
  color: #842029;
  background-color: #f8d7da;
  border-color: #f5c2c7;
}
  </style>
</head>
<body>
  <div class="page">
    <div class="topbar">
      <span>{{ header_title }}</span>
      {% if plugin_version %}
      <span class="version-badge">v{{ plugin_version }}</span>
      {% endif %}
    </div>

    <div class="container">
      <div class="card">
        <div class="card-header">
          <h1 class="card-title">{{ card_title }}</h1>
        </div>

        <div class="card-body">
          <form class="d-none">{% csrf_token %}</form>

          <div id="search-alert" class="alert d-none" role="alert"></div>

          <div class="search-input-wrapper">
            <input 
              type="text" 
              id="search-input" 
              class="search-input" 
              placeholder="Suchen nach Teilen, Beschreibungen, IPN..."
              autocomplete="off"
            />
            <span class="search-icon">üîç</span>
          </div>

          <div id="results-container" class="results-container d-none">
            <div id="results-list"></div>
          </div>

          <div id="no-results" class="no-results d-none">
            Keine Ergebnisse gefunden.
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="container">
    <footer style="text-align:center; font-size:0.85em; color:#666; padding:1rem 0;">
      ¬© 2025 GrischaMedia ‚Äì <a href="https://github.com/grischamedia/ch.grischamedia.inventree.search" target="_blank" style="color:#0d6efd; text-decoration:none;">GitHub Repository</a>
    </footer>
  </div>

  <script>
    (function() {
      const SEARCH = {
        csrf: '{{ csrf_token }}',
        apiUrl: "{% url 'plugin:gm-search:api-search' %}",
        searchTimeout: null
      };

      function getCookie(name) {
        const value = `; ${document.cookie}`;
        const parts = value.split(`; ${name}=`);
        if (parts.length === 2) return parts.pop().split(';').shift();
        return SEARCH.csrf || null;
      }

      function setAlert(kind, msg) {
        const el = document.getElementById('search-alert');
        if (!el) return;
        el.classList.remove('d-none', 'alert-success', 'alert-danger', 'alert-info', 'alert-warning');
        el.classList.add(`alert-${kind}`);
        el.textContent = msg;
      }

      function clearAlert() {
        const el = document.getElementById('search-alert');
        if (!el) return;
        el.classList.add('d-none');
        el.textContent = '';
      }

      function renderResults(results) {
        const container = document.getElementById('results-container');
        const list = document.getElementById('results-list');
        const noResults = document.getElementById('no-results');

        if (!container || !list || !noResults) return;

        if (results.length === 0) {
          container.classList.add('d-none');
          noResults.classList.remove('d-none');
          return;
        }

        container.classList.remove('d-none');
        noResults.classList.add('d-none');
        list.innerHTML = '';

        results.forEach(result => {
          const item = document.createElement('div');
          item.className = 'result-item';

          const content = document.createElement('div');
          content.className = 'result-item-content';

          const title = document.createElement('h4');
          const link = document.createElement('a');
          link.href = result.url || '#';
          if (result.url) link.target = '_blank';
          link.textContent = result.name;
          title.appendChild(link);
          content.appendChild(title);

          const meta = document.createElement('div');
          meta.className = 'result-meta';
          let metaText = `<span class="badge badge-primary">${result.type}</span>`;
          if (result.ipn) {
            metaText += ` | IPN: ${result.ipn}`;
          }
          if (result.category) {
            metaText += ` | Kategorie: ${result.category}`;
          }
          meta.innerHTML = metaText;
          content.appendChild(meta);

          if (result.description) {
            const desc = document.createElement('div');
            desc.className = 'result-description';
            desc.textContent = result.description;
            content.appendChild(desc);
          }

          item.appendChild(content);

          // Sidebar mit Lagerort und St√ºckanzahl
          const sidebar = document.createElement('div');
          sidebar.className = 'result-item-sidebar';
          let sidebarText = '';
          if (result.location) {
            sidebarText += `<div><strong>Lagerort:</strong><br>${result.location}</div>`;
          }
          if (result.quantity !== undefined && result.quantity !== null) {
            sidebarText += `<div style="margin-top: 0.5rem;"><strong>St√ºck:</strong> ${result.quantity}</div>`;
          }
          if (sidebarText) {
            sidebar.innerHTML = sidebarText;
            item.appendChild(sidebar);
          }

          list.appendChild(item);
        });
      }

      async function performSearch(query) {
        if (!query || query.trim().length < 1) {
          document.getElementById('results-container')?.classList.add('d-none');
          document.getElementById('no-results')?.classList.add('d-none');
          clearAlert();
          return;
        }

        try {
          const res = await fetch(`${SEARCH.apiUrl}?q=${encodeURIComponent(query)}`);
          
          let data;
          try {
            data = await res.json();
          } catch (jsonError) {
            // Wenn JSON-Parsing fehlschl√§gt, versuche Text zu lesen
            const text = await res.text();
            setAlert('danger', 'Fehler bei der Suche: Ung√ºltige Antwort vom Server');
            return;
          }

          if (!res.ok) {
            let errorMsg = data.error || data.detail || `Fehler (${res.status})`;
            // Fehlermeldungen auf Deutsch √ºbersetzen
            if (errorMsg.includes('string did not match the expected pattern')) {
              errorMsg = 'Ung√ºltiges Suchformat';
            } else if (errorMsg.includes('method_not_allowed')) {
              errorMsg = 'Methode nicht erlaubt';
            } else if (errorMsg.includes('plugin_not_loaded')) {
              errorMsg = 'Plugin nicht geladen';
            } else if (errorMsg.includes('search_disabled')) {
              errorMsg = 'Suche ist deaktiviert';
            }
            setAlert('danger', errorMsg);
            return;
          }

          const results = data.results || [];
          renderResults(results);

          if (results.length === 0) {
            clearAlert();
          } else {
            clearAlert();
          }
        } catch (e) {
          let errorMsg = 'Unbekannter Fehler';
          if (e.message) {
            // Fehlermeldungen auf Deutsch √ºbersetzen
            if (e.message.includes('string did not match the expected pattern')) {
              errorMsg = 'Ung√ºltiges Suchformat';
            } else if (e.message.includes('Failed to fetch')) {
              errorMsg = 'Verbindungsfehler';
            } else if (e.message.includes('NetworkError')) {
              errorMsg = 'Netzwerkfehler';
            } else {
              errorMsg = e.message;
            }
          }
          setAlert('danger', 'Fehler bei der Suche: ' + errorMsg);
        }
      }

      function bindEvents() {
        const input = document.getElementById('search-input');
        if (!input) return;

        input.addEventListener('input', (e) => {
          const query = e.target.value.trim();

          if (SEARCH.searchTimeout) {
            clearTimeout(SEARCH.searchTimeout);
          }

          SEARCH.searchTimeout = setTimeout(() => {
            performSearch(query);
          }, 300);
        });

        input.addEventListener('keydown', (e) => {
          if (e.key === 'Enter') {
            e.preventDefault();
            if (SEARCH.searchTimeout) {
              clearTimeout(SEARCH.searchTimeout);
            }
            performSearch(e.target.value.trim());
          }
        });
      }

      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', bindEvents);
      } else {
        bindEvents();
      }
    })();
  </script>
</body>
</html>

